
import com.example.config.RaftConfig;
import java.net.InetAddress;
import java.util.*;
import java.util.concurrent.ConcurrentSkipListSet;

/**
 * Dynamic in-memory RAFT member registry.
 * Keeps membership synchronized across leader/followers via RAFT log or heartbeats.
 */
public class DynamicRaftRegistry {

    private static final Set<String> activeMembers = new ConcurrentSkipListSet<>();

    /** Called at startup to merge configured and local entries. */
    public static synchronized List<String> registerAndGetMembers(RaftConfig cfg, int actualPort) {
        String self = cfg.getBindAddress() + "[" + actualPort + "]";
        if (cfg.getMembers() != null) activeMembers.addAll(cfg.getMembers());
        activeMembers.add(self);
        System.out.printf("üìã Current RAFT members: %s%n", activeMembers);
        return new ArrayList<>(activeMembers);
    }

    /** Called when leader or heartbeat propagates updated membership list. */
    public static synchronized void updateFromLeader(Collection<String> latestMembers) {
        activeMembers.addAll(latestMembers);
        System.out.printf("üîÅ Registry synced from leader: %s%n", activeMembers);
    }

    /** Returns the active members in this node‚Äôs view. */
    public static List<String> getActiveMembers() {
        return new ArrayList<>(activeMembers);
    }

    /** Ensure hostname is resolved properly if bind-address is localhost. */
    public static void resolveHostname(RaftConfig cfg) {
        try {
            if ("localhost".equals(cfg.getBindAddress()) || cfg.getBindAddress() == null) {
                cfg.setBindAddress(InetAddress.getLocalHost().getHostName());
            }
        } catch (Exception ignored) {}
    }
}
